{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workbookDisplayName":  {             
            "type":"string",
            "defaultValue": "My Workbook",
            "metadata": {
                "description": "The friendly name for the workbook that is used in the Gallery or Saved List. Needs to be unique in the scope of the resource group and source" 
            }
        },
        "workbookType":  {             
            "type":"string",
            "defaultValue": "tsg",
            "metadata": {
                "description": "The gallery that the workbook will been shown under. Supported values include workbook, `tsg`, Azure Monitor, etc." 
            }
        },
        "workbookSourceId":  {             
            "type":"string",
            "defaultValue": "<insert-your-resource-id-here>",
            "metadata": {
                "description": "The id of resource instance to which the workbook will be associated" 
            }
        },
        "workbookId": {
            "type":"string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "The unique guid for this workbook instance" 
            }
        }
    },    
    "resources": [
        {
            "name": "[parameters('workbookId')]",
            "type": "Microsoft.Insights/workbooks",
            "location": "westeurope",
            "kind": "shared",
            "apiVersion": "2018-06-17-preview",
            "dependsOn": [],
            "properties": {
                "displayName": "[parameters('workbookDisplayName')]",
                "serializedData": "{\r\n  \"version\": \"Notebook\/1.0\",\r\n  \"isLocked\": true,\r\n  \"items\": [\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"# Intune Compliance Activity\"\r\n      },\r\n      \"conditionalVisibility\": null\r\n    },\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"## Parameters\"\r\n      },\r\n      \"conditionalVisibility\": null\r\n    },\r\n    {\r\n      \"type\": 9,\r\n      \"content\": {\r\n        \"version\": \"KqlParameterItem\/1.0\",\r\n        \"query\": \"\",\r\n        \"crossComponentResources\": [],\r\n        \"parameters\": [\r\n          {\r\n            \"id\": \"e619c617-b735-4537-bcea-725a2d69d447\",\r\n            \"version\": \"KqlParameterItem\/1.0\",\r\n            \"name\": \"TimeRange\",\r\n            \"type\": 4,\r\n            \"isRequired\": true,\r\n            \"value\": {\r\n              \"durationMs\": 259200000,\r\n              \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n              \"isInitialTime\": false,\r\n              \"grain\": 1,\r\n              \"useDashboardTimeRange\": false\r\n            },\r\n            \"isHiddenWhenLocked\": false,\r\n            \"typeSettings\": {\r\n              \"selectableValues\": [\r\n                {\r\n                  \"durationMs\": 1800000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 3600000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 14400000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 43200000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 86400000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 172800000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 259200000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 604800000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 1209600000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 2592000000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 5184000000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                },\r\n                {\r\n                  \"durationMs\": 7776000000,\r\n                  \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n                  \"isInitialTime\": false,\r\n                  \"grain\": 1,\r\n                  \"useDashboardTimeRange\": false\r\n                }\r\n              ],\r\n              \"allowCustom\": true\r\n            },\r\n            \"timeContextFromParameter\": null\r\n          }\r\n        ],\r\n        \"style\": \"pills\",\r\n        \"resourceType\": \"microsoft.resourcegraph\/resources\"\r\n      },\r\n      \"conditionalVisibility\": null\r\n    },\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"## Devices not in compliance Trend\"\r\n      },\r\n      \"conditionalVisibility\": null\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem\/1.0\",\r\n        \"query\": \"let ComplianceLogs=\\r\\nIntuneOperationalLogs \\r\\n| where OperationName == \\\"Compliance\\\" \\r\\n| project TimeGenerated, Properties;\\r\\nComplianceLogs\\r\\n| sort by TimeGenerated desc\\r\\n| join (\\r\\nComplianceLogs\\r\\n| extend myJson = todynamic(Properties)\\r\\n| project-away Properties\\r\\n| extend IntuneDeviceId=tostring(myJson[\\\"IntuneDeviceId\\\"]) \\r\\n| project TimeGenerated, IntuneDeviceId\\r\\n| summarize TimeGenerated=max(TimeGenerated) by IntuneDeviceId    \\r\\n) on TimeGenerated\\r\\n| project-away TimeGenerated1, IntuneDeviceId  \\r\\n| summarize EventCount=count() by bin(TimeGenerated, {TimeRange:grain})\",\r\n        \"showQuery\": false,\r\n        \"size\": 2,\r\n        \"aggregation\": 0,\r\n        \"showAnnotations\": true,\r\n        \"showAnalytics\": false,\r\n        \"timeContext\": {\r\n          \"durationMs\": 0,\r\n          \"endTime\": null,\r\n          \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n          \"isInitialTime\": false,\r\n          \"grain\": 1,\r\n          \"useDashboardTimeRange\": false\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"resourceType\": \"microsoft.operationalinsights\/workspaces\",\r\n        \"visualization\": \"barchart\"\r\n      },\r\n      \"conditionalVisibility\": null\r\n    },\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"## Compliance Failures by Failure Reason\"\r\n      },\r\n      \"conditionalVisibility\": null,\r\n      \"customWidth\": \"50\"\r\n    },\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"## Compliance Failures by Operating System\"\r\n      },\r\n      \"conditionalVisibility\": null,\r\n      \"customWidth\": \"50\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem\/1.0\",\r\n        \"query\": \"let ComplianceLogs=\\r\\nIntuneOperationalLogs \\r\\n| where OperationName == \\\"Compliance\\\" \\r\\n| project TimeGenerated, Properties;\\r\\nComplianceLogs\\r\\n| sort by TimeGenerated desc\\r\\n| join (\\r\\nComplianceLogs\\r\\n| extend myJson = todynamic(Properties)\\r\\n| project-away Properties\\r\\n| extend IntuneDeviceId=tostring(myJson[\\\"IntuneDeviceId\\\"]) \\r\\n| project TimeGenerated, IntuneDeviceId\\r\\n| summarize TimeGenerated=max(TimeGenerated) by IntuneDeviceId    \\r\\n) on TimeGenerated\\r\\n| project-away TimeGenerated1, IntuneDeviceId  \\r\\n| extend myJson=todynamic(Properties)\\r\\n| project-away Properties\\r\\n| extend Description=tostring(myJson[\\\"Description\\\"])\\r\\n| extend Description=tostring(extract(\\\"(.*?)_IID_.*\\\", 1, tostring(Description)))\\r\\n| extend Reason = tostring(extract(\\\"(.*?)\\\\\\\\.(.*)\\\", 2, tostring(Description)))\\r\\n| summarize FailureCount=count() by Reason \\r\\n| sort by FailureCount desc\",\r\n        \"showQuery\": false,\r\n        \"size\": 1,\r\n        \"aggregation\": 0,\r\n        \"showAnnotations\": false,\r\n        \"showAnalytics\": false,\r\n        \"timeContext\": {\r\n          \"durationMs\": 0,\r\n          \"endTime\": null,\r\n          \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n          \"isInitialTime\": false,\r\n          \"grain\": 1,\r\n          \"useDashboardTimeRange\": false\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"resourceType\": \"microsoft.operationalinsights\/workspaces\",\r\n        \"visualization\": \"table\",\r\n        \"gridSettings\": {\r\n          \"formatters\": [\r\n            {\r\n              \"columnMatch\": \"FailureCount\",\r\n              \"formatter\": 3,\r\n              \"formatOptions\": {\r\n                \"showIcon\": true\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      \"conditionalVisibility\": null,\r\n      \"customWidth\": \"50\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem\/1.0\",\r\n        \"query\": \"let ComplianceLogs=\\r\\nIntuneOperationalLogs \\r\\n| where OperationName == \\\"Compliance\\\" \\r\\n| project TimeGenerated, Properties;\\r\\nComplianceLogs\\r\\n| sort by TimeGenerated desc\\r\\n| join (\\r\\nComplianceLogs\\r\\n| extend myJson = todynamic(Properties)\\r\\n| project-away Properties\\r\\n| extend IntuneDeviceId=tostring(myJson[\\\"IntuneDeviceId\\\"]) \\r\\n| project TimeGenerated, IntuneDeviceId\\r\\n| summarize TimeGenerated=max(TimeGenerated) by IntuneDeviceId    \\r\\n) on TimeGenerated\\r\\n| project-away TimeGenerated1, IntuneDeviceId  \\r\\n| extend myJson=todynamic(Properties)\\r\\n| project-away Properties\\r\\n| extend DeviceOperatingSystem=tostring(myJson[\\\"DeviceOperatingSystem\\\"]) \\r\\n| summarize FailureCount=count() by DeviceOperatingSystem\\r\\n| sort by FailureCount desc\",\r\n        \"showQuery\": false,\r\n        \"size\": 2,\r\n        \"aggregation\": 0,\r\n        \"showAnnotations\": false,\r\n        \"showAnalytics\": false,\r\n        \"timeContext\": {\r\n          \"durationMs\": 0,\r\n          \"endTime\": null,\r\n          \"createdTime\": \"2019-03-04T13:47:02.400Z\",\r\n          \"isInitialTime\": false,\r\n          \"grain\": 1,\r\n          \"useDashboardTimeRange\": false\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"resourceType\": \"microsoft.operationalinsights\/workspaces\",\r\n        \"visualization\": \"table\",\r\n        \"gridSettings\": {\r\n          \"formatters\": [\r\n            {\r\n              \"columnMatch\": \"FailureCount\",\r\n              \"formatter\": 3,\r\n              \"formatOptions\": {\r\n                \"showIcon\": true\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      \"conditionalVisibility\": null,\r\n      \"customWidth\": \"50\"\r\n    }\r\n  ],\r\n  \"$schema\": \"https:\/\/github.com\/Microsoft\/Application-Insights-Workbooks\/blob\/master\/schema\/workbook.json\"\r\n}",
                "version": "1.0",
                "sourceId": "[parameters('workbookSourceId')]",
                "category": "[parameters('workbookType')]"
            }
        }
    ],
    "outputs": {
        "workbookId": {
            "type": "string",
            "value": "[resourceId( 'Microsoft.Insights/workbooks', parameters('workbookId'))]"
        }
    }
}